<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Laika 0.18.0 + Helium Theme" />
    <title>Deployment</title>
    
    
      <meta name="description" content="Documentation for http4s"/>
    
    
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tonsky/FiraCode@1.207/distr/fira_code.css">
    
    <link rel="stylesheet" type="text/css" href="helium/icofont.min.css" />
    <link rel="stylesheet" type="text/css" href="helium/laika-helium.css" />
    <script src="helium/laika-helium.js"></script>
    <script src="helium/laika-versions.js"></script>
    <script>initVersions("../", "/deployment.html", "1.0");</script>
    
    <script> /* for avoiding page load transitions */ </script>
  </head>

  <body>

    <header id="top-bar">

      <div class="row">
        <a id="nav-icon">
          <i class="icofont-laika" title="Navigation">&#xefa2;</i>
        </a>
        
        <div id="version-menu-container">
          <a id="version-menu-toggle" class="text-link drop-down-toggle" href="#">
            Version 1.0
          </a>
          <nav id="version-menu">
            <ul id="version-list" class="nav-list">
            </ul>
          </nav>
        </div>
        
      </div>
  
      <a class="icon-link" href="../"><i class="icofont-laika" title="Home">&#xef47;</i></a>
      
      <span class="row"><a class="icon-link svg-link" href="https://github.com/http4s/http4s"><span title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a><a class="icon-link" href="https://discord.gg/XF3CXcMzqD"><i class="icofont-laika" title="Chat">&#xeed5;</i></a><a class="icon-link" href="https://twitter.com/http4s"><i class="icofont-laika" title="Twitter">&#xed7a;</i></a></span>
      
    </header>

    <nav id="sidebar">

      <ul class="nav-list">
        <li class="level1"><a href="index.html">Quick Start</a></li>
        <li class="level1"><a href="integrations.html">Integrations</a></li>
        <li class="level1"><a href="upgrading.html">Upgrading</a></li>
        <li class="level1"><a href="service.html">Service</a></li>
        <li class="level1"><a href="dsl.html">The http4s DSL</a></li>
        <li class="level1"><a href="middleware.html">Middleware</a></li>
        <li class="level1"><a href="auth.html">Authentication</a></li>
        <li class="level1"><a href="cors.html">CORS</a></li>
        <li class="level1"><a href="csrf.html">CSRF</a></li>
        <li class="level1"><a href="gzip.html">GZip Compression</a></li>
        <li class="level1"><a href="hsts.html">HSTS</a></li>
        <li class="level1"><a href="static.html">Static Files</a></li>
        <li class="level1"><a href="client.html">HTTP Client</a></li>
        <li class="level1"><a href="entity.html">Entity Handling</a></li>
        <li class="level1"><a href="streaming.html">Streaming</a></li>
        <li class="level1"><a href="json.html">JSON Handling</a></li>
        <li class="level1"><a href="testing.html">Testing</a></li>
        <li class="level1"><a href="uri.html">URI Handling</a></li>
        <li class="level1 active"><a href="#">Deployment</a></li>
        <li class="level1"><a href="error-handling.html">Error Handling</a></li>
        <li class="level1"><a href="methods.html">HTTP Methods</a></li>
      </ul>

      <ul class="nav-list">
        <li class="level1 nav-header">Related Projects</li>
        <li class="level2"><a href="https://github.com/http4s/blaze">blaze</a></li>
        <li class="level2"><a href="https://jdk-http-client.http4s.org/">http4s-jdk-http-client</a></li>
        <li class="level2"><a href="https://github.com/http4s/rho">rho</a></li>
      </ul>
      
    </nav>

    <div id="container">

      <nav id="page-nav">
        <p class="header"><a href="#">Deployment</a></p>
        
        <ul class="nav-list">
          <li class="level1"><a href="#overview">Overview</a></li>
          <li class="level2"><a href="#assembled-jar">Assembled JAR</a></li>
          <li class="level2"><a href="#graal-native-image">Graal Native Image</a></li>
          <li class="level2"><a href="#optional-get-or-build-a-muslc-bundle-required-to-build-a-static-image">(Optional) Get or build a muslC bundle required to build a static image.</a></li>
          <li class="level2"><a href="#meta-inf-resources-for-reflection">META-INF resources for reflection</a></li>
        </ul>
        
        <p class="footer"><a href="https://github.com/http4s/http4s/tree/main/docs/jvm/src/main/mdoc/deployment.md"><i class="icofont-laika" title="Edit">&#xef10;</i>Edit this page</a></p>
      </nav>

      <main class="content">

        <h1 id="deployment" class="title">Deployment</h1>
        
        <h2 id="overview" class="section">Overview<a class="anchor-link right" href="#overview"><i class="icofont-laika">&#xef71;</i></a></h2>
        <p>You&#39;ve built and tested your service. How can we deploy it into production? One approach is to create an assembled JAR containing the service with all its dependencies. We can then execute it via <code>java -jar</code>. Another approach would be to create a native image binary via <a href="https://www.graalvm.org/">GraalVM</a>. We will give each of these as examples below. </p>
        
        <h3 id="assembled-jar" class="section">Assembled JAR<a class="anchor-link right" href="#assembled-jar"><i class="icofont-laika">&#xef71;</i></a></h3>
        <p>As an example of building an assembled JAR we can use SBT with the <code>sbt-assembly</code> plugin. Simliar approaches should exist for other build tools. Consult their documentation. For SBT we find the plugin <a href="https://github.com/sbt/sbt-assembly">https://github.com/sbt/sbt-assembly</a>.</p>
        <p>For a simple project we should be able to add the sbt-assembly plugin to <code>project/plugins.sbt</code> and then run the <code>assembly</code> task. We might need to use a merge strategy if some of our dependencies have conflicting artifacts. Below is a simple example, but following the documentation will give more specific configuration examples.</p>
        <p>in project/plugins.sbt:</p>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="identifier">addSbtPlugin</span><span>(</span><span class="string-literal">&quot;com.eed3si9n&quot;</span><span> % </span><span class="string-literal">&quot;sbt-assembly&quot;</span><span> % </span><span class="string-literal">&quot;sbt-assembly-version&quot;</span><span>)</span></code></pre>
        <p>Then as long as we have a <code>main</code> method in our project:</p>
        <pre class="keep-together pdf epub"><code class="sh">sbt assembly</code></pre>
        <p>should build our &quot;fat&quot; assembly jar. We should see the path of the assembly from the sbt log. For example <code>target/scala-2.13/project-assembly-0.0.1-SNAPSHOT.jar</code></p>
        <p>Finally we can execute the jar with </p>
        <pre class="keep-together pdf epub"><code class="sh">java -jar /path.to/project-assembly-0.0.1-SNAPSHOT.jar</code></pre>
        <p>At this point you should see your http4s server start up. Regarding the artifact, it might be a good idea to place it inside a docker container or create a service script via a systemd unit or similar.</p>
        
        <h3 id="graal-native-image" class="section">Graal Native Image<a class="anchor-link right" href="#graal-native-image"><i class="icofont-laika">&#xef71;</i></a></h3>
        <p>We provide an outline for building a static native image below. Furthermore the <a href="https://github.com/http4s/http4s.g8">http4s giter8 template</a> can be used to build a native image in conjunction with this guide. </p>
        <p>Why would we create such an image? Some advantages might be faster startup times or less memory usage than the JVM.</p>
        
        <h4 id="install-graalvm-and-native-image-plugin" class="section">Install GraalVM and Native Image plugin<a class="anchor-link right" href="#install-graalvm-and-native-image-plugin"><i class="icofont-laika">&#xef71;</i></a></h4>
        <p>The first step is to install the core GraalVM and <code>native-image</code> plugin. The core GraalVM release might be thought of as a replacement for the JVM. The <code>native-image</code> plugin is required to create the binary. The <a href="https://github.com/graalvm/graalvm-ce-builds/releases">community edition builds</a> are free. </p>
        <p>After installing the core GraalVM you should be able to use it as a JDK. For example you might set <code>JAVA_HOME</code> to point to your Graal version. Otherwise, your build platform might allow you to select the Java library to build against Graal. </p>
        <pre class="keep-together pdf epub"><code class="sh">export JAVA_HOME=/path/to/graalVM</code></pre>
        <p>then</p>
        <pre class="keep-together pdf epub"><code class="sh">java --version</code></pre>
        <p>should return something like</p>
        <pre><code>openjdk 11.0.6 2020-01-14
OpenJDK Runtime Environment GraalVM CE 20.0.0 (build 11.0.6+9-jvmci-20.0-b02)
OpenJDK 64-Bit Server VM GraalVM CE 20.0.0 (build 11.0.6+9-jvmci-20.0-b02, mixed mode, sharing)</code></pre>
        
        <h3 id="optional-get-or-build-a-muslc-bundle-required-to-build-a-static-image" class="section">(Optional) Get or build a muslC bundle required to build a static image.<a class="anchor-link right" href="#optional-get-or-build-a-muslc-bundle-required-to-build-a-static-image"><i class="icofont-laika">&#xef71;</i></a></h3>
        <p>Note: Static images aren&#39;t supported in <a href="https://github.com/oracle/graal/issues/478">MacOS or Windows</a> . If building for those platforms skip this step</p>
        <p>To create a truly static native image we <a href="https://github.com/oracle/graal/issues/1919#issuecomment-589085506">need to use muslC</a> . Instructions and an example bundle are provided <a href="https://github.com/gradinac/musl-bundle-example">here</a>. For the sake of our example, we can download the resulting bundle for our build. We will need to use the path to the unpacked bundle as an argument to build the image.</p>
        <pre class="keep-together pdf epub"><code class="sh">wget https://github.com/gradinac/musl-bundle-example/releases/download/v1.0/musl.tar.gz -O - | tar -xz</code></pre>
        
        <h3 id="meta-inf-resources-for-reflection" class="section">META-INF resources for reflection<a class="anchor-link right" href="#meta-inf-resources-for-reflection"><i class="icofont-laika">&#xef71;</i></a></h3>
        <p>We need META-INF resources whenever we use reflection. Reflection isn&#39;t used in http4s, though it is used by some logging implementations. We&#39;ve provided a native image example in the <a href="https://github.com/http4s/http4s.g8">http4s giter8 template</a></p>
        
        <h4 id="build-an-assembled-jar-using-graalvm" class="section">Build an assembled jar using GraalVM<a class="anchor-link right" href="#build-an-assembled-jar-using-graalvm"><i class="icofont-laika">&#xef71;</i></a></h4>
        <p>After installing the above dependencies you should build an assembled JAR. We can again use <code>sbt assembly</code> or your favorite build tool / plugin to create the assembled jar. The important thing is that we should be using the GraalVM version of Java to do so.</p>
        
        <h4 id="create-the-native-image-with-the-assembled-jar" class="section">Create the native image with the assembled JAR<a class="anchor-link right" href="#create-the-native-image-with-the-assembled-jar"><i class="icofont-laika">&#xef71;</i></a></h4>
        <p>After we have built the assembled JAR containing all our Java dependencies, we use that JAR to build our native image. In the command below we need to replace the muslC and assembly jar paths with the appropriate locations.</p>
        <p>Note: Mac and Windows platforms do not support build static images. Remove <code>--static</code> and <code>-H:UseMuslC=&quot;/path.to/muslC&quot;</code> when building for those platforms.</p>
        <pre class="keep-together pdf epub"><code class="sh">native-image --static -H:+ReportExceptionStackTraces -H:UseMuslC=&quot;/path.to/muslC&quot; --allow-incomplete-classpath --no-fallback --initialize-at-build-time --enable-http --enable-https --enable-all-security-services --verbose -jar &quot;./path.to.assembly.jar&quot; projectBinaryImage</code></pre>
        <p>A breakout for the command parameters (image generation options) :</p>
        <p><code>-H:UseMuslC</code> to fix DNS and related segfaults and build a true static image that doesn&#39;t depend on linked libraries. </p>
        <p><code>--initialize-at-build-time</code> again is related to building the static image. Again we lose performance if we instead do this at runtime.</p>
        <p><code>--enable-http</code>, <code>--enable-https</code> should correspond to related protocols</p>
        <p><code>--enable-all-security-services</code> will likely be required to make or receive https requests.</p>
        <p>Additional image generation options are found in the <a href="https://www.graalvm.org/docs/reference-manual/native-image/">native image reference</a></p>
        
        <h4 id="execute-the-native-image" class="section">Execute the native image<a class="anchor-link right" href="#execute-the-native-image"><i class="icofont-laika">&#xef71;</i></a></h4>
        <p>Finally we should be able to execute our output <code>projectBinaryImage</code></p>
        <pre class="keep-together pdf epub"><code class="sh">./projectBinaryImage</code></pre>
        <p>At this point we may want to package the binary in a docker container, integrate the image generation to a greater build process, create init scripts via systemd, etc.</p>
        
        <h4 id="why-static" class="section">Why static?<a class="anchor-link right" href="#why-static"><i class="icofont-laika">&#xef71;</i></a></h4>
        <p>As an alternative to executing via the JVM, GraalVM&#39;s native-image allows us to execute as a native binary. For example, in Linux environments this might be known as an <code>ELF</code> format. There are a number of ways to generate a native image, be it dynamic or static. </p>
        <p>A dynamic image is less portable because it depends on shared libary files on each Linux host. Then similar to creating an assembly JAR containing all our Java dependencies, when we build a static native image, we build
        a more portable assembly including all the dependencies to run our binary across multiple platforms. For example we could expect a static ELF-64 binary to work across multiple linux distributions of different versions for the same architecture.</p>

      </main>

    </div>

  </body>
</html>