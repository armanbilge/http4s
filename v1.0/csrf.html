<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Laika 0.18.0 + Helium Theme" />
    <title>CSRF</title>
    
    
      <meta name="description" content="Documentation for http4s"/>
    
    
    
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/tonsky/FiraCode@1.207/distr/fira_code.css">
    
    <link rel="stylesheet" type="text/css" href="helium/icofont.min.css" />
    <link rel="stylesheet" type="text/css" href="helium/laika-helium.css" />
    <script src="helium/laika-helium.js"></script>
    <script src="helium/laika-versions.js"></script>
    <script>initVersions("../", "/csrf.html", "1.0");</script>
    
    <script> /* for avoiding page load transitions */ </script>
  </head>

  <body>

    <header id="top-bar">

      <div class="row">
        <a id="nav-icon">
          <i class="icofont-laika" title="Navigation">&#xefa2;</i>
        </a>
        
        <div id="version-menu-container">
          <a id="version-menu-toggle" class="text-link drop-down-toggle" href="#">
            Version 1.0
          </a>
          <nav id="version-menu">
            <ul id="version-list" class="nav-list">
            </ul>
          </nav>
        </div>
        
      </div>
  
      <a class="icon-link" href="../"><i class="icofont-laika" title="Home">&#xef47;</i></a>
      
      <span class="row"><a class="icon-link svg-link" href="https://github.com/http4s/http4s"><span title="Source Code"><svg class="svg-icon" width="100%" height="100%" viewBox="0 0 100 100" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
  <g class="svg-shape">
    <path d="M49.995,1c-27.609,-0 -49.995,22.386 -49.995,50.002c-0,22.09 14.325,40.83 34.194,47.444c2.501,0.458 3.413,-1.086 3.413,-2.412c0,-1.185 -0.043,-4.331 -0.067,-8.503c-13.908,3.021 -16.843,-6.704 -16.843,-6.704c-2.274,-5.773 -5.552,-7.311 -5.552,-7.311c-4.54,-3.103 0.344,-3.042 0.344,-3.042c5.018,0.356 7.658,5.154 7.658,5.154c4.46,7.64 11.704,5.433 14.552,4.156c0.454,-3.232 1.744,-5.436 3.174,-6.685c-11.102,-1.262 -22.775,-5.553 -22.775,-24.713c-0,-5.457 1.949,-9.92 5.147,-13.416c-0.516,-1.265 -2.231,-6.348 0.488,-13.233c0,0 4.199,-1.344 13.751,5.126c3.988,-1.108 8.266,-1.663 12.518,-1.682c4.245,0.019 8.523,0.574 12.517,1.682c9.546,-6.47 13.736,-5.126 13.736,-5.126c2.728,6.885 1.013,11.968 0.497,13.233c3.204,3.496 5.141,7.959 5.141,13.416c0,19.209 -11.691,23.436 -22.83,24.673c1.795,1.544 3.394,4.595 3.394,9.26c0,6.682 -0.061,12.076 -0.061,13.715c0,1.338 0.899,2.894 3.438,2.406c19.853,-6.627 34.166,-25.354 34.166,-47.438c-0,-27.616 -22.389,-50.002 -50.005,-50.002"/>
  </g>
</svg></span></a><a class="icon-link" href="https://discord.gg/XF3CXcMzqD"><i class="icofont-laika" title="Chat">&#xeed5;</i></a><a class="icon-link" href="https://twitter.com/http4s"><i class="icofont-laika" title="Twitter">&#xed7a;</i></a></span>
      
    </header>

    <nav id="sidebar">

      <ul class="nav-list">
        <li class="level1"><a href="index.html">Quick Start</a></li>
        <li class="level1"><a href="integrations.html">Integrations</a></li>
        <li class="level1"><a href="upgrading.html">Upgrading</a></li>
        <li class="level1"><a href="service.html">Service</a></li>
        <li class="level1"><a href="dsl.html">The http4s DSL</a></li>
        <li class="level1"><a href="middleware.html">Middleware</a></li>
        <li class="level1"><a href="auth.html">Authentication</a></li>
        <li class="level1"><a href="cors.html">CORS</a></li>
        <li class="level1 active"><a href="#">CSRF</a></li>
        <li class="level1"><a href="gzip.html">GZip Compression</a></li>
        <li class="level1"><a href="hsts.html">HSTS</a></li>
        <li class="level1"><a href="static.html">Static Files</a></li>
        <li class="level1"><a href="client.html">HTTP Client</a></li>
        <li class="level1"><a href="entity.html">Entity Handling</a></li>
        <li class="level1"><a href="streaming.html">Streaming</a></li>
        <li class="level1"><a href="json.html">JSON Handling</a></li>
        <li class="level1"><a href="testing.html">Testing</a></li>
        <li class="level1"><a href="uri.html">URI Handling</a></li>
        <li class="level1"><a href="deployment.html">Deployment</a></li>
        <li class="level1"><a href="error-handling.html">Error Handling</a></li>
        <li class="level1"><a href="methods.html">HTTP Methods</a></li>
      </ul>

      <ul class="nav-list">
        <li class="level1 nav-header">Related Projects</li>
        <li class="level2"><a href="https://github.com/http4s/blaze">blaze</a></li>
        <li class="level2"><a href="https://jdk-http-client.http4s.org/">http4s-jdk-http-client</a></li>
        <li class="level2"><a href="https://github.com/http4s/rho">rho</a></li>
      </ul>
      
    </nav>

    <div id="container">

      <nav id="page-nav">
        <p class="header"><a href="#">CSRF</a></p>
        
        <ul class="nav-list">
        </ul>
        
        <p class="footer"><a href="https://github.com/http4s/http4s/tree/main/docs/jvm/src/main/mdoc/csrf.md"><i class="icofont-laika" title="Edit">&#xef10;</i>Edit this page</a></p>
      </nav>

      <main class="content">

        <h1 id="csrf" class="title">CSRF</h1>
        <p>Http4s provides <a href="../middleware">Middleware</a>, named <code>CSRF</code>, to prevent Cross-site request forgery attacks. This middleware
        is modeled after the <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#double-submit-cookie">double submit cookie pattern</a>.</p>
        <p>Examples in this document have the following dependencies.</p>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="identifier">libraryDependencies</span><span> ++= </span><span class="type-name">Seq</span><span>(
  </span><span class="string-literal">&quot;org.http4s&quot;</span><span> %% </span><span class="string-literal">&quot;http4s-dsl&quot;</span><span> % </span><span class="identifier">http4sVersion</span><span>,
  </span><span class="string-literal">&quot;org.http4s&quot;</span><span> %% </span><span class="string-literal">&quot;http4s-server&quot;</span><span> % </span><span class="identifier">http4sVersion</span><span>
)</span></code></pre>
        <p>And we need some imports.</p>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">http4s</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">http4s</span><span>.</span><span class="identifier">dsl</span><span>.</span><span class="identifier">io</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">http4s</span><span>.</span><span class="identifier">implicits</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">http4s</span><span>.</span><span class="identifier">server</span><span>.</span><span class="identifier">middleware</span><span>.</span><span class="identifier">_</span></code></pre>
        <p>If you&#39;re in a REPL, we also need a runtime:</p>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="identifier">unsafe</span><span>.</span><span class="type-name">IORuntime</span><span>
</span><span class="keyword">implicit</span><span> </span><span class="keyword">val</span><span> </span><span class="identifier">runtime</span><span>: </span><span class="type-name">IORuntime</span><span> = </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="identifier">unsafe</span><span>.</span><span class="type-name">IORuntime</span><span>.</span><span class="identifier">global</span></code></pre>
        <p>Let&#39;s start by making a simple service.</p>
        <pre><code class="nohighlight"><span class="keyword">val</span><span> </span><span class="identifier">service</span><span> = </span><span class="type-name">HttpRoutes</span><span>.</span><span class="identifier">of</span><span>[</span><span class="type-name">IO</span><span>] {
  </span><span class="keyword">case</span><span> </span><span class="identifier">_</span><span> =&gt;
    </span><span class="type-name">Ok</span><span>()
} 
</span><span class="comment">// service: HttpRoutes[IO] = Kleisli(
//   org.http4s.HttpRoutes$$$Lambda$25439/0x0000000802f7a2d0@453fcb16
// ) 
</span><span>
</span><span class="keyword">val</span><span> </span><span class="identifier">request</span><span> = </span><span class="type-name">Request</span><span>[</span><span class="type-name">IO</span><span>](</span><span class="type-name">Method</span><span>.</span><span class="type-name">GET</span><span>, </span><span class="string-literal">uri&quot;/&quot;</span><span>)
</span><span class="comment">// request: Request[IO] = (
//   GET,
//   Uri(None, None, /, , None),
//   HttpVersion(1, 1),
//   Headers(),
//   Stream(..),
//   org.typelevel.vault.Vault@74eeff70
// )
</span><span>
</span><span class="identifier">service</span><span>.</span><span class="identifier">orNotFound</span><span>(</span><span class="identifier">request</span><span>).</span><span class="identifier">unsafeRunSync</span><span>()
</span><span class="comment">// res0: Response[IO] = (
//   Status(200),
//   HttpVersion(1, 1),
//   Headers(Content-Length: 0),
//   Stream(..),
//   org.typelevel.vault.Vault@5ea6cc36
// )</span></code></pre>
        <p>That didn&#39;t do all that much. Lets build out our CSRF Middleware by creating a <code>CSRFBuilder</code></p>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">val</span><span> </span><span class="identifier">cookieName</span><span> = </span><span class="string-literal">&quot;csrf-token&quot;</span><span>
</span><span class="keyword">val</span><span> </span><span class="identifier">key</span><span>  = </span><span class="type-name">CSRF</span><span>.</span><span class="identifier">generateSigningKey</span><span>[</span><span class="type-name">IO</span><span>].</span><span class="identifier">unsafeRunSync</span><span>()
</span><span class="keyword">val</span><span> </span><span class="identifier">defaultOriginCheck</span><span>: </span><span class="type-name">Request</span><span>[</span><span class="type-name">IO</span><span>] =&gt; </span><span class="type-name">Boolean</span><span> =
  </span><span class="type-name">CSRF</span><span>.</span><span class="identifier">defaultOriginCheck</span><span>[</span><span class="type-name">IO</span><span>](</span><span class="identifier">_</span><span>, </span><span class="string-literal">&quot;localhost&quot;</span><span>, </span><span class="type-name">Uri</span><span>.</span><span class="type-name">Scheme</span><span>.</span><span class="identifier">http</span><span>, </span><span class="type-name">None</span><span>)
</span><span class="keyword">val</span><span> </span><span class="identifier">csrfBuilder</span><span> = </span><span class="type-name">CSRF</span><span>[</span><span class="type-name">IO</span><span>,</span><span class="type-name">IO</span><span>](</span><span class="identifier">key</span><span>, </span><span class="identifier">defaultOriginCheck</span><span>)</span></code></pre>
        <p>More info on what is possible in the <a href="../api/org/http4s/server/middleware/csrf$$csrfbuilder">CSRFBuilder</a> Docs,
        but we will create a fairly simple CSRF Middleware in our example.</p>
        <pre class="keep-together pdf epub"><code class="nohighlight"><span class="keyword">val</span><span> </span><span class="identifier">csrf</span><span> = </span><span class="identifier">csrfBuilder</span><span>
  .</span><span class="identifier">withCookieName</span><span>(</span><span class="identifier">cookieName</span><span>)
  .</span><span class="identifier">withCookieDomain</span><span>(</span><span class="type-name">Some</span><span>(</span><span class="string-literal">&quot;localhost&quot;</span><span>))
  .</span><span class="identifier">withCookiePath</span><span>(</span><span class="type-name">Some</span><span>(</span><span class="string-literal">&quot;/&quot;</span><span>))
  .</span><span class="identifier">build</span><span>
</span><span class="comment">// csrf: CSRF[IO, IO] = org.http4s.server.middleware.CSRF@2b43a24f</span></code></pre>
        <p>Now we need to wrap this around our service! We&#39;re gonna start with a safe call</p>
        <pre><code class="nohighlight"><span class="keyword">val</span><span> </span><span class="identifier">dummyRequest</span><span>: </span><span class="type-name">Request</span><span>[</span><span class="type-name">IO</span><span>] =
    </span><span class="type-name">Request</span><span>[</span><span class="type-name">IO</span><span>](</span><span class="identifier">method</span><span> = </span><span class="type-name">Method</span><span>.</span><span class="type-name">GET</span><span>).</span><span class="identifier">putHeaders</span><span>(</span><span class="string-literal">&quot;Origin&quot;</span><span> -&gt; </span><span class="string-literal">&quot;http://localhost&quot;</span><span>)
</span><span class="comment">// dummyRequest: Request[IO] = (
//   GET,
//   Uri(None, None, /, , None),
//   HttpVersion(1, 1),
//   Headers(Origin: http://localhost),
//   Stream(..),
//   org.typelevel.vault.Vault@101fbb4a
// )
</span><span class="keyword">val</span><span> </span><span class="identifier">resp</span><span> = </span><span class="identifier">csrf</span><span>.</span><span class="identifier">validate</span><span>()(</span><span class="identifier">service</span><span>.</span><span class="identifier">orNotFound</span><span>)(</span><span class="identifier">dummyRequest</span><span>).</span><span class="identifier">unsafeRunSync</span><span>()
</span><span class="comment">// resp: Response[IO] = (
//   Status(200),
//   HttpVersion(1, 1),
//   Headers(Content-Length: 0, Set-Cookie: csrf-token=D8B8D64BB30CF6993214B8C664E61C856BE71DEE60A1B06CFD5417E12D77AFD5-1633323818720-0E249B9A402C1F2432D86AE5E8E423237CE4A443; Domain=localhost; Path=/; SameSite=Lax; HttpOnly),
//   Stream(..),
//   org.typelevel.vault.Vault@1389d346
// )</span></code></pre>
        <p>Notice how the response has the CSRF cookies added. How easy was
        that? And, as described in <a href="../middleware">Middleware</a>, services and middleware can be
        composed such that only some of your endpoints are CSRF enabled. By default, 
        safe methods will update the CSRF token, while unsafe methods will validate them.</p>
        <p>Without getting too deep into it, safe methods are OPTIONS, GET, and HEAD. While unsafe methods are 
        POST, PUT, PATCH, DELETE, and TRACE. To put it simply, state changing methods are unsafe. For more information,
        check out this cheat sheet on <a href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html#double-submit-cookie">CSRF Prevention</a>.</p>
        <p>Unsafe requests (like POST) require us to send the CSRF token in the <code>X-Csrf-Token</code>
        header (this is the default name, but it can be changed), so we are going to get the value
        and send it up in our POST. I&#39;ve also added the response cookie as a RequestCookie, normally
        the browser would send this up with our request, but I needed to do it manually for the purpose of this demo.</p>
        <pre><code class="nohighlight"><span class="keyword">val</span><span> </span><span class="identifier">cookie</span><span> = </span><span class="identifier">resp</span><span>.</span><span class="identifier">cookies</span><span>.</span><span class="identifier">head</span><span>
</span><span class="comment">// cookie: ResponseCookie = ResponseCookie(
//   &quot;csrf-token&quot;,
//   &quot;D8B8D64BB30CF6993214B8C664E61C856BE71DEE60A1B06CFD5417E12D77AFD5-1633323818720-0E249B9A402C1F2432D86AE5E8E423237CE4A443&quot;,
//   None,
//   None,
//   Some(&quot;localhost&quot;),
//   Some(&quot;/&quot;),
//   Some(Lax),
//   false,
//   true,
//   None
// )
</span><span class="keyword">val</span><span> </span><span class="identifier">dummyPostRequest</span><span>: </span><span class="type-name">Request</span><span>[</span><span class="type-name">IO</span><span>] =
    </span><span class="type-name">Request</span><span>[</span><span class="type-name">IO</span><span>](</span><span class="identifier">method</span><span> = </span><span class="type-name">Method</span><span>.</span><span class="type-name">POST</span><span>).</span><span class="identifier">putHeaders</span><span>(
      </span><span class="string-literal">&quot;Origin&quot;</span><span> -&gt; </span><span class="string-literal">&quot;http://localhost&quot;</span><span>,
      </span><span class="string-literal">&quot;X-Csrf-Token&quot;</span><span> -&gt; </span><span class="identifier">cookie</span><span>.</span><span class="identifier">content</span><span>
    ).</span><span class="identifier">addCookie</span><span>(</span><span class="type-name">RequestCookie</span><span>(</span><span class="identifier">cookie</span><span>.</span><span class="identifier">name</span><span>,</span><span class="identifier">cookie</span><span>.</span><span class="identifier">content</span><span>))
</span><span class="comment">// dummyPostRequest: Request[IO] = (
//   POST,
//   Uri(None, None, /, , None),
//   HttpVersion(1, 1),
//   Headers(Origin: http://localhost, X-Csrf-Token: D8B8D64BB30CF6993214B8C664E61C856BE71DEE60A1B06CFD5417E12D77AFD5-1633323818720-0E249B9A402C1F2432D86AE5E8E423237CE4A443, Cookie: csrf-token=D8B8D64BB30CF6993214B8C664E61C856BE71DEE60A1B06CFD5417E12D77AFD5-1633323818720-0E249B9A402C1F2432D86AE5E8E423237CE4A443),
//   Stream(..),
//   org.typelevel.vault.Vault@4d41ee8c
// )
</span><span class="keyword">val</span><span> </span><span class="identifier">validateResp</span><span> = 
  </span><span class="identifier">csrf</span><span>.</span><span class="identifier">validate</span><span>()(</span><span class="identifier">service</span><span>.</span><span class="identifier">orNotFound</span><span>)(</span><span class="identifier">dummyPostRequest</span><span>).</span><span class="identifier">unsafeRunSync</span><span>()
</span><span class="comment">// validateResp: Response[IO] = (
//   Status(200),
//   HttpVersion(1, 1),
//   Headers(Content-Length: 0, Set-Cookie: csrf-token=D8B8D64BB30CF6993214B8C664E61C856BE71DEE60A1B06CFD5417E12D77AFD5-1633323818764-60AAC933841F1107B45BCCACB3AEF1D59C7161DA; Domain=localhost; Path=/; SameSite=Lax; HttpOnly),
//   Stream(..),
//   org.typelevel.vault.Vault@2069d985
// )</span></code></pre>

      </main>

    </div>

  </body>
</html>